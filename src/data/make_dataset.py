# -*- coding: utf-8 -*-
"""eda.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1nLiOyy9ADNFxXY9fSmKUSdDR24jXchxx
"""

import argparse
import os
import logging
from pathlib import Path
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns

# Configuración del logger
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
logger = logging.getLogger(__name__)

def load_data(path: str) -> pd.DataFrame:

    logger.info(f"Cargando datos desde: {path}")
    try:
        if path.startswith("s3://"):
            import s3fs
            key = os.getenv("AWS_ACCESS_KEY_ID")
            secret = os.getenv("AWS_SECRET_ACCESS_KEY")


            if not key or not secret:
                raise EnvironmentError(
                    "Credenciales AWS no encontradas. Define AWS_ACCESS_KEY_ID y AWS_SECRET_ACCESS_KEY."
                )

            storage_opts = {"key": key, "secret": secret}


            df = pd.read_csv(path, storage_options=storage_opts)
        else:
            df = pd.read_csv(path)

        logger.info(f"Datos cargados correctamente. Forma: {df.shape}")
        return df
    except Exception as e:
        logger.error(f"Error al cargar el dataset: {e}")
        raise

def clean_data(df: pd.DataFrame) -> pd.DataFrame:
    logger.info("Iniciando limpieza de datos...")

    # Ejemplo: eliminar nulos en columnas críticas
    columnas_criticas = ['Age', 'Absenteeism time in hours']
    df = df.dropna(subset=columnas_criticas)

    # Reemplazar ceros en columnas donde no sean válidos
    cols_con_ceros = [c for c in df.columns if df[c].dtype in ['float64', 'int64']]
    for c in cols_con_ceros:
        if (df[c] == 0).sum() > 0:
            mediana = df[c].median()
            df[c] = df[c].replace(0, mediana)
            logger.info(f"Reemplazados ceros en {c} con la mediana ({mediana:.2f})")

    logger.info("Limpieza completada.")
    return df

def generate_boxplots(df: pd.DataFrame, output_dir: Path):
    """Genera boxplots para todas las variables numéricas y los guarda."""
    logger.info("Generando boxplots por variable numérica...")
    output_dir.mkdir(parents=True, exist_ok=True)

    numeric_cols = df.select_dtypes(include=[np.number]).columns
    for col in numeric_cols:
        plt.figure(figsize=(6, 4))
        sns.boxplot(x=df[col], color="skyblue")
        plt.title(f"Boxplot - {col}")
        plt.tight_layout()
        safe_col = col.replace("/", "_").replace(" ", "_")
        path = output_dir / f"boxplot_{safe_col}.png"
        plt.savefig(path)
        plt.close()
        logger.info(f"Boxplot guardado: {path}")

def summarize_data(df: pd.DataFrame):
    """Muestra resumen estadístico del dataset."""
    logger.info("Resumen estadístico del dataset:")
    logger.info(df.describe(include='all').to_string())

def save_clean_data(df: pd.DataFrame, output_path: Path):
    """Guarda el dataset limpio en formato CSV."""
    output_path.parent.mkdir(parents=True, exist_ok=True)
    df.to_csv(output_path, index=False)
    logger.info(f"Dataset limpio guardado en: {output_path}")

def main(args):
    df = load_data(args.input)
    summarize_data(df)

    df_clean = clean_data(df)
    generate_boxplots(df_clean, Path(args.figures_dir))
    save_clean_data(df_clean, Path(args.output))

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="EDA y limpieza de datos desde S3 o local.")
    parser.add_argument("--input", type=str, required=True, help="Ruta del archivo CSV (local o S3).")
    parser.add_argument("--output", type=str, default="data/processed/clean_data.csv", help="Ruta para guardar el CSV limpio.")
    parser.add_argument("--figures_dir", type=str, default="reports/figures", help="Directorio donde guardar las gráficas.")
    args = parser.parse_args()
    main(args)